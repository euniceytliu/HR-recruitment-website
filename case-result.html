<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä¾‹è¯„ä¼°ç»“æœæŸ¥è¯¢ - è…¾è®¯HRèŒä¸šæˆé•¿ä¼™ä¼´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 40px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* æŸ¥è¯¢å¡ç‰‡ */
        .query-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
        }

        .query-card h2 {
            color: #2d3748;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .btn-query {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-query:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }

        .btn-query:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: none;
        }

        .result-header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #fef5e7;
            color: #d68910;
        }

        .status-reviewed {
            background: #d5f4e6;
            color: #0f5132;
        }

        .status-rejected {
            background: #fadbd8;
            color: #c0392b;
        }

        .score-display {
            margin: 30px 0;
            text-align: center;
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #48bb78 0deg,
                #48bb78 var(--score-deg),
                #e2e8f0 var(--score-deg),
                #e2e8f0 360deg
            );
            animation: fillScore 1.5s ease-out;
        }

        @keyframes fillScore {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .score-circle::after {
            content: '';
            position: absolute;
            width: 85%;
            height: 85%;
            background: white;
            border-radius: 50%;
        }

        .score-number {
            font-size: 3.5em;
            font-weight: bold;
            color: #2d3748;
            z-index: 1;
        }

        .score-label {
            font-size: 1.1em;
            color: #718096;
            z-index: 1;
        }

        .section {
            margin: 30px 0;
        }

        .section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .dimension-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .dimension-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .dimension-name {
            font-weight: 600;
            color: #2d3748;
        }

        .dimension-score {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .dimension-comment {
            color: #4a5568;
            line-height: 1.6;
        }

        .feedback-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.6;
            color: #2d3748;
        }

        .feedback-item::before {
            content: 'â€¢';
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.2em;
        }

        .strength-item {
            border-left-color: #48bb78;
        }

        .strength-item::before {
            content: 'âœ“';
            color: #48bb78;
        }

        .improvement-item {
            border-left-color: #ed8936;
        }

        .improvement-item::before {
            content: '!';
            color: #ed8936;
        }

        .suggestion-item {
            border-left-color: #4299e1;
        }

        .suggestion-item::before {
            content: 'ğŸ’¡';
        }

        .case-info {
            background: #ebf8ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .case-info-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #bee3f8;
        }

        .case-info-row:last-child {
            border-bottom: none;
        }

        .case-info-label {
            font-weight: 500;
            color: #2c5282;
            width: 120px;
            flex-shrink: 0;
        }

        .case-info-value {
            color: #2d3748;
            flex: 1;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff5e1;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            color: #075985;
        }

        .btn-back {
            display: block;
            width: 100%;
            padding: 14px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            margin-top: 30px;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: #667eea;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ¡ˆä¾‹è¯„ä¼°ç»“æœæŸ¥è¯¢</h1>
            <p>æŸ¥çœ‹æ‚¨çš„æ¡ˆä¾‹è¯„å®¡è¿›åº¦å’Œè¯¦ç»†åé¦ˆ</p>
        </div>

        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="query-card" id="queryCard">
            <h2>ğŸ“‹ è¾“å…¥ä¿¡æ¯æŸ¥è¯¢ç»“æœ</h2>
            
            <form id="queryForm" onsubmit="queryResult(event)">
                <div class="form-group">
                    <label>æ‰‹æœºå· *</label>
                    <input type="tel" id="phone" required 
                           placeholder="è¯·è¾“å…¥æäº¤æ—¶å¡«å†™çš„æ‰‹æœºå·"
                           pattern="1[3-9]\d{9}">
                </div>

                <div class="form-group">
                    <label>é‚®ç®± *</label>
                    <input type="email" id="email" required 
                           placeholder="è¯·è¾“å…¥æäº¤æ—¶å¡«å†™çš„é‚®ç®±">
                </div>

                <button type="submit" class="btn-query" id="queryBtn">
                    ğŸ” æŸ¥è¯¢ç»“æœ
                </button>
            </form>

            <div class="alert alert-info" style="margin-top: 20px;">
                <strong>ğŸ’¡ æç¤º</strong><br>
                è¯·è¾“å…¥æ‚¨æäº¤æ¡ˆä¾‹æ—¶å¡«å†™çš„<strong>æ‰‹æœºå·</strong>å’Œ<strong>é‚®ç®±</strong>è¿›è¡ŒæŸ¥è¯¢ã€‚<br>
                è¯„å®¡é€šå¸¸åœ¨æäº¤å 3-5 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆã€‚
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="result-card" id="resultCard">
            <!-- ç»“æœå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gevvmjwjmpjhwczfuiru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdldnZtandqbXBqaHdjemZ1aXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTkyOTYsImV4cCI6MjA4MTc5NTI5Nn0.iA0eIjnudgmYHsVE_ioHTR8fR84oIciQqqNcbSBZ33I';

        let supabaseClient;

        window.onload = function() {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        };

        async function queryResult(event) {
            event.preventDefault();

            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const queryBtn = document.getElementById('queryBtn');
            const resultCard = document.getElementById('resultCard');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            queryBtn.disabled = true;
            queryBtn.innerHTML = 'â³ æŸ¥è¯¢ä¸­...';
            resultCard.style.display = 'none';

            try {
                // ğŸ”’ å®‰å…¨æŸ¥è¯¢ï¼šä½¿ç”¨ RPC å‡½æ•°æŸ¥è¯¢ï¼ˆæœ€å®‰å…¨ï¼‰
                const { data, error } = await supabaseClient
                    .rpc('query_case_by_phone_email', {
                        p_phone: phone,
                        p_email: email
                    });

                console.log('ğŸ” å®‰å…¨æŸ¥è¯¢ - ä½¿ç”¨ RPC å‡½æ•°');

                if (error) {
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                    // å¦‚æœ RPC ä¸å­˜åœ¨ï¼Œå›é€€åˆ°ç›´æ¥æŸ¥è¯¢
                    if (error.code === 'PGRST202' || error.message.includes('function')) {
                        console.log('âš ï¸ RPC å‡½æ•°ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç›´æ¥æŸ¥è¯¢');
                        const { data: fallbackData, error: fallbackError } = await supabaseClient
                            .from('case_submissions')
                            .select('id, case_name, status, score, feedback, created_at, reviewed_at, reviewer')
                            .eq('phone', phone)
                            .eq('email', email)
                            .order('created_at', { ascending: false })
                            .limit(1);
                        
                        if (fallbackError) throw fallbackError;
                        
                        if (!fallbackData || fallbackData.length === 0) {
                            alert('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ¡ˆä¾‹è®°å½•\n\nè¯·æ£€æŸ¥æ‰‹æœºå·å’Œé‚®ç®±æ˜¯å¦æ­£ç¡®ã€‚');
                            return;
                        }
                        
                        displayResult(fallbackData[0]);
                        document.getElementById('queryCard').style.display = 'none';
                        resultCard.style.display = 'block';
                        return;
                    }
                    throw error;
                }

                if (!data || data.length === 0) {
                    alert('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ¡ˆä¾‹è®°å½•\n\nè¯·æ£€æŸ¥æ‰‹æœºå·å’Œé‚®ç®±æ˜¯å¦æ­£ç¡®ã€‚');
                    return;
                }

                // æ˜¾ç¤ºç»“æœ
                displayResult(data[0]);
                
                // éšè—æŸ¥è¯¢å¡ç‰‡ï¼Œæ˜¾ç¤ºç»“æœå¡ç‰‡
                document.getElementById('queryCard').style.display = 'none';
                resultCard.style.display = 'block';

            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error);
                alert('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message);
            } finally {
                queryBtn.disabled = false;
                queryBtn.innerHTML = 'ğŸ” æŸ¥è¯¢ç»“æœ';
            }
        }

        function displayResult(caseData) {
            const resultCard = document.getElementById('resultCard');
            const status = caseData.status || 'pending';
            const statusText = {
                'pending': 'å¾…å®¡æ ¸',
                'reviewed': 'å·²è¯„å®¡',
                'rejected': 'æœªé€šè¿‡'
            }[status] || 'å¾…å®¡æ ¸';

            const statusClass = {
                'pending': 'status-pending',
                'reviewed': 'status-reviewed',
                'rejected': 'status-rejected'
            }[status] || 'status-pending';

            let content = '';

            // å¤´éƒ¨çŠ¶æ€
            content += `
                <div class="result-header">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                    <h2>æ¡ˆä¾‹è¯„ä¼°ç»“æœ</h2>
                </div>
            `;

            // æ¡ˆä¾‹åŸºæœ¬ä¿¡æ¯
            content += `
                <div class="case-info">
                    <div class="case-info-row">
                        <span class="case-info-label">å§“å</span>
                        <span class="case-info-value">${caseData.name}</span>
                    </div>
                    <div class="case-info-row">
                        <span class="case-info-label">å­¦æ ¡</span>
                        <span class="case-info-value">${caseData.school || 'æœªå¡«å†™'}</span>
                    </div>
                    <div class="case-info-row">
                        <span class="case-info-label">æ¡ˆä¾‹åç§°</span>
                        <span class="case-info-value">${caseData.case_name}</span>
                    </div>
                    <div class="case-info-row">
                        <span class="case-info-label">æäº¤æ—¶é—´</span>
                        <span class="case-info-value">${new Date(caseData.created_at).toLocaleString('zh-CN')}</span>
                    </div>
                    ${caseData.reviewed_at ? `
                    <div class="case-info-row">
                        <span class="case-info-label">è¯„å®¡æ—¶é—´</span>
                        <span class="case-info-value">${new Date(caseData.reviewed_at).toLocaleString('zh-CN')}</span>
                    </div>
                    ` : ''}
                </div>
            `;

            if (status === 'pending') {
                // å¾…å®¡æ ¸çŠ¶æ€
                content += `
                    <div class="alert alert-warning">
                        <strong>â³ æ‚¨çš„æ¡ˆä¾‹æ­£åœ¨å®¡æ ¸ä¸­</strong><br>
                        æˆ‘ä»¬é€šå¸¸åœ¨ 3-5 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆè¯„å®¡ã€‚<br>
                        è¯„å®¡å®Œæˆåï¼Œæ‚¨å¯ä»¥å›åˆ°æ­¤é¡µé¢æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚<br>
                        <br>
                        <strong>æ¸©é¦¨æç¤ºï¼š</strong>è¯·ä¿å­˜æ­¤é¡µé¢é“¾æ¥ï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢ã€‚
                    </div>
                `;
            } else if (status === 'reviewed' && caseData.score) {
                // å·²è¯„å®¡çŠ¶æ€ - æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                const score = caseData.score;
                const scoreDeg = (score / 105) * 360; // æ»¡åˆ†105ï¼ˆ100+5åŠ åˆ†ï¼‰

                content += `
                    <div class="score-display">
                        <div class="score-circle" style="--score-deg: ${scoreDeg}deg">
                            <div class="score-number">${score}</div>
                            <div class="score-label">æ€»åˆ† / 105</div>
                        </div>
                    </div>
                `;

                // è§£æåé¦ˆJSON
                let evaluation = null;
                try {
                    evaluation = JSON.parse(caseData.feedback);
                } catch (e) {
                    console.error('è§£æè¯„ä¼°æ•°æ®å¤±è´¥:', e);
                }

                if (evaluation) {
                    // å„ç»´åº¦å¾—åˆ†
                    if (evaluation.dimensions) {
                        content += `
                            <div class="section">
                                <h3>ğŸ“Š å„ç»´åº¦è¯„åˆ†</h3>
                        `;

                        const dimensionNames = {
                            completeness: 'ğŸ“‹ æäº¤ææ–™å®Œæ•´æ€§',
                            product: 'ğŸ¯ äº§å“åŠŸèƒ½ä¸è´¨é‡',
                            aiCollaboration: 'ğŸ¤– AIååŒèƒ½åŠ›',
                            delivery: 'ğŸš€ å…¨æµç¨‹äº¤ä»˜èƒ½åŠ›',
                            learning: 'ğŸ’¡ å­¦ä¹ èƒ½åŠ›ä¸åˆ›æ–°æ€§',
                            documentation: 'ğŸ“„ æ–‡æ¡£è´¨é‡ï¼ˆåŠ åˆ†é¡¹ï¼‰'
                        };

                        for (const [key, dim] of Object.entries(evaluation.dimensions)) {
                            content += `
                                <div class="dimension-item">
                                    <div class="dimension-header">
                                        <span class="dimension-name">${dimensionNames[key] || key}</span>
                                        <span class="dimension-score">${dim.score}/${dim.maxScore}åˆ†</span>
                                    </div>
                                    <div class="dimension-comment">${dim.comment}</div>
                                </div>
                            `;
                        }

                        content += `</div>`;
                    }

                    // ä¸»è¦ä¼˜åŠ¿
                    if (evaluation.strengths && evaluation.strengths.length > 0) {
                        content += `
                            <div class="section">
                                <h3>âœ¨ ä¸»è¦ä¼˜åŠ¿</h3>
                        `;

                        evaluation.strengths.forEach(s => {
                            content += `
                                <div class="feedback-item strength-item">${s}</div>
                            `;
                        });

                        content += `</div>`;
                    }

                    // æ”¹è¿›å»ºè®®
                    if (evaluation.improvements && evaluation.improvements.length > 0) {
                        content += `
                            <div class="section">
                                <h3>ğŸ“ˆ æ”¹è¿›å»ºè®®</h3>
                        `;

                        evaluation.improvements.forEach(i => {
                            content += `
                                <div class="feedback-item improvement-item">${i}</div>
                            `;
                        });

                        content += `</div>`;
                    }

                    // å‘å±•å»ºè®®
                    if (evaluation.suggestions && evaluation.suggestions.length > 0) {
                        content += `
                            <div class="section">
                                <h3>ğŸ’¼ èŒä¸šå‘å±•å»ºè®®</h3>
                        `;

                        evaluation.suggestions.forEach(s => {
                            content += `
                                <div class="feedback-item suggestion-item">${s}</div>
                            `;
                        });

                        content += `</div>`;
                    }
                }

                // è¯„å®¡ç»“è®º
                content += `
                    <div class="alert alert-info" style="margin-top: 30px;">
                        <strong>ğŸ“‹ è¯„å®¡ç»“è®º</strong><br>
                        ${score >= 80 ? 'ğŸ‰ <strong>ä¼˜ç§€ï¼</strong>æ‚¨çš„æ¡ˆä¾‹è´¨é‡å¾ˆé«˜ï¼Œå±•ç°äº†å‡ºè‰²çš„AIåº”ç”¨èƒ½åŠ›å’Œäº§å“äº¤ä»˜èƒ½åŠ›ã€‚' : ''}
                        ${score >= 60 && score < 80 ? 'ğŸ‘ <strong>è‰¯å¥½ï¼</strong>æ‚¨çš„æ¡ˆä¾‹æœ‰ä¸€å®šè´¨é‡ï¼Œå»ºè®®å‚è€ƒæ”¹è¿›å»ºè®®è¿›ä¸€æ­¥æå‡ã€‚' : ''}
                        ${score < 60 ? 'ğŸ’ª <strong>éœ€è¦æ”¹è¿›ã€‚</strong>å»ºè®®æ‚¨å‚è€ƒè¯„å®¡åé¦ˆï¼Œä¼˜åŒ–äº§å“åŠŸèƒ½å’Œææ–™å®Œæ•´æ€§åé‡æ–°æäº¤ã€‚' : ''}
                        <br><br>
                        å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»HRå›¢é˜Ÿï¼šhr@tencent.com
                    </div>
                `;
            } else {
                // å…¶ä»–çŠ¶æ€
                content += `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ æš‚æ— è¯¦ç»†è¯„ä¼°ç»“æœ</strong><br>
                        è¯„å®¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨åå†æŸ¥è¯¢ã€‚
                    </div>
                `;
            }

            // è¿”å›æŒ‰é’®
            content += `
                <a href="javascript:void(0)" class="btn-back" onclick="backToQuery()">
                    â† è¿”å›æŸ¥è¯¢é¡µé¢
                </a>
            `;

            resultCard.innerHTML = content;
        }

        function backToQuery() {
            document.getElementById('queryCard').style.display = 'block';
            document.getElementById('resultCard').style.display = 'none';
            document.getElementById('queryForm').reset();
        }
    </script>
</body>
</html>
