# ğŸ”’ ç½‘ç«™å®‰å…¨åŠ å›ºæŒ‡å—

## å½“å‰å®‰å…¨çŠ¶å†µ

### âš ï¸ å­˜åœ¨çš„å®‰å…¨é£é™©

1. **é«˜é£é™©ï¼šå­¦ç”Ÿéšç§æ•°æ®æš´éœ²**
   - æ‰‹æœºå·ã€é‚®ç®±ã€å§“åç­‰æ•æ„Ÿä¿¡æ¯
   - ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®æ•°æ®åº“

2. **ä¸­é£é™©ï¼šæ•°æ®å¯èƒ½è¢«ç¯¡æ”¹**
   - è¯„åˆ†ã€è¯„ä¼°ç»“æœå¯ä»¥è¢«ä¿®æ”¹

3. **ä½é£é™©ï¼šæ¶æ„æäº¤**
   - æ²¡æœ‰é¢‘ç‡é™åˆ¶å’ŒéªŒè¯

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåŠ å¼º RLS ç­–ç•¥ï¼ˆå¿«é€Ÿï¼Œé€‚åˆå¼€å‘/æµ‹è¯•ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å†…éƒ¨æµ‹è¯•ç¯å¢ƒ
- çŸ­æœŸä½¿ç”¨
- å—ä¿¡ä»»çš„ç”¨æˆ·ç¾¤ä½“

**å®æ–½æ­¥éª¤ï¼š**

1. åœ¨ Supabase SQL Editor æ‰§è¡Œï¼š

```sql
-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "å…è®¸æ‰€æœ‰äººè¯»å–æ¡ˆä¾‹" ON case_submissions;
DROP POLICY IF EXISTS "å…è®¸æ‰€æœ‰äººæäº¤æ¡ˆä¾‹" ON case_submissions;
DROP POLICY IF EXISTS "å…è®¸æ‰€æœ‰äººæ›´æ–°æ¡ˆä¾‹" ON case_submissions;

-- åˆ›å»ºæ›´ä¸¥æ ¼çš„ç­–ç•¥

-- 1. å…è®¸æ’å…¥ï¼ˆå­¦ç”Ÿæäº¤æ¡ˆä¾‹ï¼‰
CREATE POLICY "å…è®¸æäº¤æ¡ˆä¾‹"
ON case_submissions
FOR INSERT
TO anon
WITH CHECK (true);

-- 2. é™åˆ¶æŸ¥è¯¢ï¼ˆåªèƒ½é€šè¿‡ API æŸ¥è¯¢ï¼‰
CREATE POLICY "é™åˆ¶æŸ¥è¯¢æ¡ˆä¾‹"
ON case_submissions
FOR SELECT
TO anon
USING (false);  -- å‰ç«¯ç›´æ¥æŸ¥è¯¢è¢«é˜»æ­¢

-- 3. åªå…è®¸ authenticated è§’è‰²æŸ¥è¯¢å’Œæ›´æ–°
CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ¡ˆä¾‹"
ON case_submissions
FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æ›´æ–°æ¡ˆä¾‹"
ON case_submissions
FOR UPDATE
TO authenticated
USING (true)
WITH CHECK (true);
```

2. ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨ Service Role Keyï¼ˆåç«¯ï¼‰

**âš ï¸ ç¼ºç‚¹ï¼šå‰ç«¯ä»ç„¶å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“**

---

### æ–¹æ¡ˆBï¼šä½¿ç”¨åç«¯ APIï¼ˆæœ€å®‰å…¨ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- ç”Ÿäº§ç¯å¢ƒ
- å¤„ç†æ•æ„Ÿæ•°æ®
- éœ€è¦å¤æ‚æƒé™æ§åˆ¶

**æ¶æ„æ”¹è¿›ï¼š**

```
å­¦ç”Ÿ â†’ å‰ç«¯é¡µé¢ â†’ åç«¯ API (Node.js/Vercel Functions) â†’ Supabase
                  â†“
              éªŒè¯ã€è¿‡æ»¤ã€æƒé™æ£€æŸ¥
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ•°æ®åº“å¯†é’¥ä¸æš´éœ²
- âœ… å¯ä»¥éªŒè¯ç”¨æˆ·èº«ä»½
- âœ… å¯ä»¥æ·»åŠ éªŒè¯ç ã€é¢‘ç‡é™åˆ¶
- âœ… å¯ä»¥è¿‡æ»¤æ•æ„Ÿå­—æ®µ
- âœ… å¯ä»¥è®°å½•æ—¥å¿—

**å®æ–½æ­¥éª¤ï¼š**

1. **åˆ›å»º Vercel Serverless Functions**
2. **ä¿®æ”¹å‰ç«¯ï¼Œè°ƒç”¨ API è€Œä¸æ˜¯ç›´æ¥è®¿é—®æ•°æ®åº“**
3. **åœ¨ API ä¸­å®ç°æƒé™éªŒè¯**

è¯¦ç»†å®æ–½è¯·å‚è€ƒï¼š`SECURITY-IMPLEMENTATION.md`

---

### æ–¹æ¡ˆCï¼šä½¿ç”¨ Supabase Authï¼ˆå¹³è¡¡æ–¹æ¡ˆï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦ç”¨æˆ·ç™»å½•
- ä¸­ç­‰å®‰å…¨è¦æ±‚
- å¿«é€Ÿå®æ–½

**å®æ–½æ­¥éª¤ï¼š**

1. å¯ç”¨ Supabase é‚®ç®±ç™»å½•
2. ä¸º HR åˆ›å»ºè´¦å·
3. å­¦ç”Ÿä½¿ç”¨é­”æ³•é“¾æ¥ç™»å½•ï¼ˆæ— å¯†ç ï¼‰
4. RLS ç­–ç•¥åŸºäº `auth.uid()`

```sql
-- ç”¨æˆ·åªèƒ½çœ‹è‡ªå·±çš„æ¡ˆä¾‹
CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„æ¡ˆä¾‹"
ON case_submissions
FOR SELECT
TO authenticated
USING (auth.uid() = user_id);  -- éœ€è¦æ·»åŠ  user_id å­—æ®µ

-- HR å¯ä»¥çœ‹æ‰€æœ‰
CREATE POLICY "HRæŸ¥çœ‹æ‰€æœ‰æ¡ˆä¾‹"
ON case_submissions
FOR SELECT
TO authenticated
USING (auth.jwt() ->> 'role' = 'hr');
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | å®æ–½éš¾åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|------|----------|
| **æ–¹æ¡ˆAï¼šåŠ å¼ºRLS** | â­â­ | â­ | å…è´¹ | æµ‹è¯•/å†…éƒ¨ |
| **æ–¹æ¡ˆBï¼šåç«¯API** | â­â­â­â­â­ | â­â­â­â­ | ä½ | ç”Ÿäº§ç¯å¢ƒ |
| **æ–¹æ¡ˆCï¼šSupabase Auth** | â­â­â­â­ | â­â­ | å…è´¹ | å¿«é€Ÿä¸Šçº¿ |

---

## ğŸš¨ ç«‹å³é‡‡å–çš„ä¸´æ—¶æªæ–½

**å¦‚æœç½‘ç«™å·²ç»å…¬å¼€è®¿é—®ï¼Œè¯·ç«‹å³æ‰§è¡Œï¼š**

### 1. é™åˆ¶å‰ç«¯ç›´æ¥æŸ¥è¯¢

```sql
-- é˜»æ­¢å‰ç«¯ç›´æ¥æŸ¥è¯¢æ•æ„Ÿæ•°æ®
DROP POLICY IF EXISTS "å…è®¸æ‰€æœ‰äººè¯»å–æ¡ˆä¾‹" ON case_submissions;

CREATE POLICY "ç¦æ­¢åŒ¿åæŸ¥è¯¢"
ON case_submissions
FOR SELECT
TO anon
USING (false);
```

### 2. åˆ›å»ºåç«¯æŸ¥è¯¢ API

å‚è€ƒï¼š`api/query-case.js`

### 3. ä¿®æ”¹å‰ç«¯ä»£ç 

å‰ç«¯ä¸å†ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œæ˜¯è°ƒç”¨ APIï¼š

```javascript
// æ—§ä»£ç ï¼ˆä¸å®‰å…¨ï¼‰
const { data } = await supabase
  .from('case_submissions')
  .select('*')
  .eq('phone', phone);

// æ–°ä»£ç ï¼ˆå®‰å…¨ï¼‰
const response = await fetch('/api/query-case', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ phone, email })
});
const data = await response.json();
```

---

## ğŸ“Š æ•°æ®è„±æ•å»ºè®®

### åœ¨å‰ç«¯æ˜¾ç¤ºæ—¶è„±æ•ï¼š

```javascript
// æ‰‹æœºå·è„±æ•
function maskPhone(phone) {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
}

// é‚®ç®±è„±æ•
function maskEmail(email) {
  return email.replace(/(.{2}).*(@.*)/, '$1***$2');
}
```

### åœ¨æ•°æ®åº“å±‚é¢è„±æ•ï¼š

```sql
-- åˆ›å»ºè§†å›¾ï¼Œåªè¿”å›å¿…è¦å­—æ®µ
CREATE VIEW case_submissions_public AS
SELECT 
  id,
  case_name,
  status,
  score,
  created_at,
  -- ä¸åŒ…å« phone, email, name, school
FROM case_submissions;
```

---

## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] RLS ç­–ç•¥å·²é…ç½®ä¸”æµ‹è¯•é€šè¿‡
- [ ] æ•æ„Ÿå­—æ®µï¼ˆæ‰‹æœºå·ã€é‚®ç®±ï¼‰å·²è„±æ•
- [ ] API æœ‰é¢‘ç‡é™åˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
- [ ] æ·»åŠ äº†éªŒè¯ç ï¼ˆé˜²æ­¢æœºå™¨äººï¼‰
- [ ] æ—¥å¿—è®°å½•æ•æ„Ÿæ“ä½œ
- [ ] å®šæœŸå¤‡ä»½æ•°æ®
- [ ] ç›‘æ§å¼‚å¸¸è®¿é—®

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœéœ€è¦å®æ–½ä»¥ä¸Šä»»ä½•æ–¹æ¡ˆï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ï¼š
1. ç”Ÿæˆå®Œæ•´çš„ä»£ç 
2. æä¾›è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤
3. å¸®åŠ©æµ‹è¯•å’ŒéªŒè¯

---

## ğŸ†˜ ç´§æ€¥æƒ…å†µå¤„ç†

**å¦‚æœå‘ç°æ•°æ®æ³„éœ²ï¼š**

1. ç«‹å³ç¦ç”¨æ‰€æœ‰ RLS ç­–ç•¥ï¼š
```sql
ALTER TABLE case_submissions DISABLE ROW LEVEL SECURITY;
```

2. è”ç³»æˆ‘è·å–å¸®åŠ©

3. å¯¼å‡ºæ•°æ®å¤‡ä»½

4. ä¿®æ”¹ Supabase å¯†é’¥ï¼ˆåœ¨ Supabase Settings â†’ APIï¼‰
