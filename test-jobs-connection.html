<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•Jobsæ•°æ®åº“è¿æ¥</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Jobsæ•°æ®åº“è¿æ¥æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <button onclick="testConnection()">1. æµ‹è¯•Supabaseè¿æ¥</button>
        <button onclick="checkJobsTable()">2. æ£€æŸ¥jobsè¡¨æ˜¯å¦å­˜åœ¨</button>
        <button onclick="fetchJobs()">3. è·å–å²—ä½æ•°æ®</button>
        <button onclick="createTestJob()">4. åˆ›å»ºæµ‹è¯•å²—ä½</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>åˆ›å»ºjobsè¡¨çš„SQL</h2>
        <p class="info">å¦‚æœjobsè¡¨ä¸å­˜åœ¨ï¼Œè¯·å¤åˆ¶ä»¥ä¸‹SQLä»£ç åˆ°Supabaseçš„SQLç¼–è¾‘å™¨ä¸­æ‰§è¡Œï¼š</p>
        <button onclick="copySQL()">å¤åˆ¶SQLä»£ç </button>
        <pre id="sqlCode">CREATE TABLE IF NOT EXISTS jobs (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    department TEXT,
    location TEXT,
    requirements TEXT[],
    is_hot BOOLEAN DEFAULT FALSE,
    apply_url TEXT,
    published BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gevvmjwjmpjhwczfuiru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdldnZtandqbXBqaHdjemZ1aXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTkyOTYsImV4cCI6MjA4MTc5NTI5Nn0.iA0eIjnudgmYHsVE_ioHTR8fR84oIciQqqNcbSBZ33I';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            results.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testConnection() {
            clearResults();
            log('æµ‹è¯•Supabaseè¿æ¥...', 'info');
            
            try {
                if (typeof window.supabase === 'undefined') {
                    log('âŒ Supabaseåº“æœªåŠ è½½ï¼', 'error');
                    return;
                }

                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('âœ… Supabaseå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢
                const { data, error } = await supabase.from('jobs').select('count');
                
                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('âš ï¸ jobsè¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆåˆ›å»ºè¡¨ï¼', 'error');
                        log('è¯·å¤åˆ¶ä¸‹æ–¹çš„SQLä»£ç åˆ°Supabaseæ§åˆ¶å°æ‰§è¡Œ', 'info');
                    } else {
                        log('âŒ è¿æ¥é”™è¯¯: ' + error.message, 'error');
                    }
                } else {
                    log('âœ… è¿æ¥æˆåŠŸï¼', 'success');
                }
            } catch (err) {
                log('âŒ å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        async function checkJobsTable() {
            clearResults();
            log('æ£€æŸ¥jobsè¡¨...', 'info');
            
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    log('âŒ jobsè¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ' + error.message, 'error');
                    log('ğŸ“ è¯·å…ˆåœ¨Supabaseä¸­åˆ›å»ºjobsè¡¨', 'info');
                    return false;
                }
                
                log('âœ… jobsè¡¨å­˜åœ¨ï¼', 'success');
                return true;
            } catch (err) {
                log('âŒ å¼‚å¸¸: ' + err.message, 'error');
                return false;
            }
        }

        async function fetchJobs() {
            clearResults();
            log('è·å–å²—ä½æ•°æ®...', 'info');
            
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('published', true)
                    .order('is_hot', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) {
                    log('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
                    return;
                }
                
                if (!data || data.length === 0) {
                    log('âš ï¸ jobsè¡¨ä¸ºç©ºï¼Œæ²¡æœ‰å²—ä½æ•°æ®', 'error');
                    log('è¯·å°è¯•ä½¿ç”¨"åˆ›å»ºæµ‹è¯•å²—ä½"æŒ‰é’®æ·»åŠ ä¸€ä¸ªæµ‹è¯•å²—ä½', 'info');
                    return;
                }
                
                log(`âœ… æˆåŠŸè·å– ${data.length} ä¸ªå²—ä½`, 'success');
                log('å²—ä½åˆ—è¡¨:', 'info');
                data.forEach((job, index) => {
                    log(`${index + 1}. ${job.title} - ${job.department} - ${job.is_hot ? 'ğŸ”¥çƒ­æ‹›' : 'æ™®é€š'}`, 'info');
                });
            } catch (err) {
                log('âŒ å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        async function createTestJob() {
            clearResults();
            log('åˆ›å»ºæµ‹è¯•å²—ä½...', 'info');
            
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const testJob = {
                    title: 'æµ‹è¯•å²—ä½ - å‰ç«¯å·¥ç¨‹å¸ˆ',
                    department: 'æŠ€æœ¯éƒ¨',
                    location: 'æ·±åœ³',
                    requirements: ['3å¹´ä»¥ä¸Šå‰ç«¯å¼€å‘ç»éªŒ', 'ç†Ÿæ‚‰Reactæˆ–Vue', 'è‰¯å¥½çš„æ²Ÿé€šèƒ½åŠ›'],
                    is_hot: true,
                    apply_url: 'https://careers.tencent.com',
                    published: true
                };
                
                const { data, error } = await supabase
                    .from('jobs')
                    .insert(testJob)
                    .select();
                
                if (error) {
                    log('âŒ åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('âš ï¸ jobsè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºè¡¨ï¼', 'error');
                    }
                    return;
                }
                
                log('âœ… æµ‹è¯•å²—ä½åˆ›å»ºæˆåŠŸï¼', 'success');
                log('å²—ä½ID: ' + data[0].id, 'info');
                log('ç°åœ¨å¯ä»¥åˆ·æ–°jobs.htmlé¡µé¢æŸ¥çœ‹å²—ä½äº†', 'success');
            } catch (err) {
                log('âŒ å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        function copySQL() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('âœ… SQLä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·åˆ°Supabaseæ§åˆ¶å° â†’ SQL Editor ä¸­ç²˜è´´å¹¶æ‰§è¡Œ');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...', 'info');
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>