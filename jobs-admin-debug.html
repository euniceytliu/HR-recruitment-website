<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²—ä½ç®¡ç†è°ƒè¯•ç‰ˆ - Eunice</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .debug-panel {
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-panel p {
            margin: 5px 0;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input {
            width: auto;
        }
        .requirements-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .requirements-input input {
            flex: 1;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-delete {
            background-color: #f44336;
        }
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        .btn-secondary {
            background-color: #2196F3;
        }
        .btn-secondary:hover {
            background-color: #0b7dda;
        }
        .jobs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .job-item {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å²—ä½ç®¡ç†è°ƒè¯•ç‰ˆ</h1>

    <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
    <div class="debug-panel" id="debugLog">
        <p class="success">âœ… è°ƒè¯•é¢æ¿å·²å¯åŠ¨</p>
    </div>

    <!-- æ·»åŠ å²—ä½è¡¨å• -->
    <div class="form-container">
        <h2>æ·»åŠ æ–°å²—ä½</h2>
        
        <form id="jobForm">
            <div class="form-group">
                <label for="title">å²—ä½åç§° *</label>
                <input type="text" id="title" required>
            </div>
            
            <div class="form-group">
                <label for="department">éƒ¨é—¨</label>
                <input type="text" id="department">
            </div>
            
            <div class="form-group">
                <label for="location">å·¥ä½œåœ°ç‚¹</label>
                <input type="text" id="location">
            </div>
            
            <div class="form-group">
                <label>å²—ä½è¦æ±‚</label>
                <div id="requirementsContainer"></div>
                <button type="button" id="addRequirement" class="btn btn-secondary">æ·»åŠ è¦æ±‚</button>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="isHot">
                <label for="isHot">çƒ­æ‹›å²—ä½</label>
            </div>
            
            <div class="form-group">
                <label for="applyUrl">ç”³è¯·é“¾æ¥</label>
                <input type="url" id="applyUrl">
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="published" checked>
                <label for="published">å·²å‘å¸ƒ</label>
            </div>
            
            <button type="submit" class="btn">ğŸ’¾ ä¿å­˜å²—ä½</button>
        </form>
    </div>

    <!-- å²—ä½åˆ—è¡¨ -->
    <div class="form-container">
        <h2>å½“å‰å²—ä½åˆ—è¡¨</h2>
        <div id="jobsListContainer">
            <p>æ­£åœ¨åŠ è½½...</p>
        </div>
    </div>

    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯åº“ - å¤šä¸ªCDNå¤‡ç”¨ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // å¦‚æœjsdelivrå¤±è´¥ï¼Œå°è¯•unpkg
        if (typeof window.supabase === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@supabase/supabase-js@2';
            document.head.appendChild(script);
        }
    </script>
    
    <script>
        // ==================== è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ ====================
        const debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const colors = {
                info: '#0ff',
                success: '#0f0',
                error: '#f00',
                warning: '#ff0'
            };
            
            const p = document.createElement('p');
            p.style.color = colors[type] || '#0ff';
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugLog.appendChild(p);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(message);
        }

        // ==================== Supabaseé…ç½® ====================
        const SUPABASE_URL = 'https://gevvmjwjmpjhwczfuiru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdldnZtandqbXBqaHdjemZ1aXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTkyOTYsImV4cCI6MjA4MTc5NTI5Nn0.iA0eIjnudgmYHsVE_ioHTR8fR84oIciQqqNcbSBZ33I';

        let supabase = null;
        let checkAttempts = 0;

        // ==================== åˆå§‹åŒ–æ£€æŸ¥ ====================
        function checkEnvironment() {
            checkAttempts++;
            log(`ğŸ” å¼€å§‹ç¯å¢ƒæ£€æŸ¥... (ç¬¬${checkAttempts}æ¬¡)`);
            
            if (typeof window.supabase === 'undefined') {
                log('âŒ Supabaseåº“æœªåŠ è½½ï¼', 'error');
                
                if (checkAttempts < 5) {
                    log(`â³ ç­‰å¾…1ç§’åé‡è¯•...`, 'warning');
                    setTimeout(checkEnvironment, 1000);
                    return false;
                } else {
                    log('âŒ å¤šæ¬¡é‡è¯•åä»æ— æ³•åŠ è½½Supabaseåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼', 'error');
                    alert('âš ï¸ æ— æ³•åŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼\n\nå¦‚æœä½¿ç”¨VPNï¼Œè¯·å°è¯•å…³é—­åé‡è¯•ã€‚');
                    return false;
                }
            }
            log('âœ… Supabaseåº“å·²åŠ è½½', 'success');
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('âœ… Supabaseå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
                
                // åˆå§‹åŒ–æˆåŠŸï¼ŒåŠ è½½æ•°æ®
                initializePage();
                return true;
            } catch (err) {
                log(`âŒ åˆ›å»ºSupabaseå®¢æˆ·ç«¯å¤±è´¥: ${err.message}`, 'error');
                return false;
            }
        }
        
        // ==================== åˆå§‹åŒ–é¡µé¢ ====================
        function initializePage() {
            log('ğŸ‰ é¡µé¢åˆå§‹åŒ–å¼€å§‹', 'success');
            
            // åˆå§‹åŒ–UI
            addRequirementInput();
            
            // åŠ è½½å²—ä½åˆ—è¡¨
            loadJobs();
        }

        // ==================== æ•°æ®åº“æ“ä½œ ====================
        async function addJob(jobData) {
            log('ğŸ“ å¼€å§‹æ·»åŠ å²—ä½...');
            log(`æ•°æ®: ${JSON.stringify(jobData, null, 2)}`);
            
            try {
                const { data, error } = await supabase
                    .from('jobs')
                    .insert(jobData)
                    .select();

                if (error) {
                    log(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
                    log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`, 'error');
                    return { success: false, error: error.message };
                }

                log('âœ… å²—ä½æ·»åŠ æˆåŠŸï¼', 'success');
                log(`è¿”å›æ•°æ®: ${JSON.stringify(data)}`, 'success');
                return { success: true, data };
            } catch (err) {
                log(`âŒ å¼‚å¸¸: ${err.message}`, 'error');
                return { success: false, error: err.message };
            }
        }

        async function getAllJobs() {
            log('ğŸ“š å¼€å§‹è·å–å²—ä½åˆ—è¡¨...');
            
            try {
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .order('is_hot', { ascending: false })
                    .order('created_at', { ascending: false });

                if (error) {
                    log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    return [];
                }

                log(`âœ… æˆåŠŸè·å– ${data.length} ä¸ªå²—ä½`, 'success');
                return data || [];
            } catch (err) {
                log(`âŒ å¼‚å¸¸: ${err.message}`, 'error');
                return [];
            }
        }

        async function deleteJob(id) {
            log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å²—ä½ID: ${id}`);
            
            try {
                const { error } = await supabase
                    .from('jobs')
                    .delete()
                    .eq('id', id);

                if (error) {
                    log(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }

                log('âœ… å²—ä½åˆ é™¤æˆåŠŸï¼', 'success');
                return { success: true };
            } catch (err) {
                log(`âŒ å¼‚å¸¸: ${err.message}`, 'error');
                return { success: false, error: err.message };
            }
        }

        // ==================== UIæ“ä½œ ====================
        function addRequirementInput(value = '') {
            const container = document.getElementById('requirementsContainer');
            const div = document.createElement('div');
            div.className = 'requirements-input';
            div.innerHTML = `
                <input type="text" class="requirement" value="${value}" placeholder="è¾“å…¥å²—ä½è¦æ±‚">
                <button type="button" class="btn btn-delete remove-requirement">åˆ é™¤</button>
            `;
            container.appendChild(div);

            div.querySelector('.remove-requirement').addEventListener('click', function() {
                div.remove();
            });
        }

        function collectFormData() {
            const requirements = Array.from(document.querySelectorAll('.requirement'))
                .map(input => input.value.trim())
                .filter(value => value !== '');

            const formData = {
                title: document.getElementById('title').value.trim(),
                department: document.getElementById('department').value.trim(),
                location: document.getElementById('location').value.trim(),
                requirements: requirements,
                is_hot: document.getElementById('isHot').checked,
                apply_url: document.getElementById('applyUrl').value.trim(),
                published: document.getElementById('published').checked
            };
            
            log('æ”¶é›†è¡¨å•æ•°æ®:', 'info');
            log(JSON.stringify(formData, null, 2), 'info');
            
            return formData;
        }

        function renderJobsList(jobs) {
            const container = document.getElementById('jobsListContainer');
            
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<p>æš‚æ— å²—ä½ä¿¡æ¯</p>';
                return;
            }

            const jobsHTML = `
                <div class="jobs-list">
                    ${jobs.map(job => `
                        <div class="job-item">
                            <h3>${job.title}</h3>
                            <p><strong>éƒ¨é—¨:</strong> ${job.department || 'æœªæŒ‡å®š'}</p>
                            <p><strong>åœ°ç‚¹:</strong> ${job.location || 'æœªæŒ‡å®š'}</p>
                            <p><strong>çŠ¶æ€:</strong> ${job.published ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'} ${job.is_hot ? '| ğŸ”¥ çƒ­æ‹›' : ''}</p>
                            <button class="btn btn-delete" onclick="deleteJobById(${job.id}, '${job.title}')">åˆ é™¤</button>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = jobsHTML;
        }

        async function loadJobs() {
            log('ğŸ”„ åˆ·æ–°å²—ä½åˆ—è¡¨...');
            const jobs = await getAllJobs();
            renderJobsList(jobs);
        }

        window.deleteJobById = async function(id, title) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å²—ä½ "${title}" å—ï¼Ÿ`)) {
                const result = await deleteJob(id);
                if (result.success) {
                    loadJobs();
                }
            }
        };

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿ1ç§’åå¼€å§‹æ£€æŸ¥ï¼ˆç»™CDNåŠ è½½ç•™è¶³æ—¶é—´ï¼‰
            setTimeout(() => {
                checkEnvironment();
            }, 1000);

            // æ·»åŠ è¦æ±‚æŒ‰é’®
            document.getElementById('addRequirement').addEventListener('click', function() {
                log('â• æ·»åŠ è¦æ±‚è¾“å…¥æ¡†');
                addRequirementInput();
            });

            // è¡¨å•æäº¤
            document.getElementById('jobForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                log('ğŸ“‹ è¡¨å•æäº¤äº‹ä»¶è§¦å‘', 'warning');
                
                const jobData = collectFormData();
                
                if (!jobData.title) {
                    log('âŒ å²—ä½åç§°ä¸ºç©º', 'error');
                    alert('è¯·å¡«å†™å²—ä½åç§°ï¼');
                    return;
                }

                log('ğŸš€ å¼€å§‹æäº¤å²—ä½æ•°æ®...', 'warning');
                const result = await addJob(jobData);

                if (result.success) {
                    alert('âœ… å²—ä½æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('jobForm').reset();
                    document.getElementById('requirementsContainer').innerHTML = '';
                    addRequirementInput();
                    loadJobs();
                } else {
                    alert('âŒ æ·»åŠ å¤±è´¥: ' + result.error);
                }
            });
        });
    </script>
</body>
</html>
