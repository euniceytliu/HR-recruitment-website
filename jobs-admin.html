<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²—ä½ç®¡ç† - Eunice</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #1a1a1a;
        }
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input {
            width: auto;
        }
        .requirements-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .requirements-input input {
            flex: 1;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-delete {
            background-color: #f44336;
        }
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        .btn-secondary {
            background-color: #2196F3;
        }
        .btn-secondary:hover {
            background-color: #0b7dda;
        }
        .jobs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .job-item {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .job-title {
            margin-top: 0;
            color: #1a1a1a;
        }
        .job-meta {
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        .success-message, .error-message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">Eunice</div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                <li><a href="blog.html" class="nav-link">åšå®¢</a></li>
                <li><a href="jobs.html" class="nav-link">çƒ­æ‹›å²—ä½</a></li>
                <li><a href="jobs-admin.html" class="nav-link active">å²—ä½ç®¡ç†</a></li>
            </ul>
        </div>
    </nav>

    <h1>å²—ä½ä¿¡æ¯ç®¡ç†</h1>

    <!-- æ·»åŠ /ç¼–è¾‘å²—ä½è¡¨å• -->
    <div class="form-container">
        <h2 id="formTitle">æ·»åŠ æ–°å²—ä½</h2>
        <div id="successMessage" class="success-message hidden"></div>
        <div id="errorMessage" class="error-message hidden"></div>
        
        <form id="jobForm">
            <input type="hidden" id="jobId">
            
            <div class="form-group">
                <label for="title">å²—ä½åç§°</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="department">éƒ¨é—¨</label>
                <input type="text" id="department" name="department">
            </div>
            
            <div class="form-group">
                <label for="location">å·¥ä½œåœ°ç‚¹</label>
                <input type="text" id="location" name="location">
            </div>
            
            <div class="form-group">
                <label>å²—ä½è¦æ±‚</label>
                <div id="requirementsContainer">
                    <div class="requirements-input">
                        <input type="text" class="requirement" placeholder="è¾“å…¥å²—ä½è¦æ±‚">
                        <button type="button" class="btn btn-delete remove-requirement">åˆ é™¤</button>
                    </div>
                </div>
                <button type="button" id="addRequirement" class="btn btn-secondary">æ·»åŠ è¦æ±‚</button>
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="isHot" name="isHot">
                <label for="isHot">çƒ­æ‹›å²—ä½</label>
            </div>
            
            <div class="form-group">
                <label for="applyUrl">ç”³è¯·é“¾æ¥</label>
                <input type="url" id="applyUrl" name="applyUrl">
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="published" name="published" checked>
                <label for="published">å·²å‘å¸ƒ</label>
            </div>
            
            <button type="submit" class="btn">ä¿å­˜å²—ä½</button>
            <button type="button" id="resetForm" class="btn btn-secondary">é‡ç½®è¡¨å•</button>
        </form>
    </div>

    <!-- å²—ä½åˆ—è¡¨ -->
    <div class="form-container">
        <h2>å½“å‰å²—ä½åˆ—è¡¨</h2>
        <div id="jobsListContainer">
            <p>æ­£åœ¨åŠ è½½å²—ä½ä¿¡æ¯...</p>
        </div>
    </div>

    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://gevvmjwjmpjhwczfuiru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdldnZtandqbXBqaHdjemZ1aXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTkyOTYsImV4cCI6MjA4MTc5NTI5Nn0.iA0eIjnudgmYHsVE_ioHTR8fR84oIciQqqNcbSBZ33I';

        // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
        let supabase = null;
        
        function initSupabase() {
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            return supabase;
        }

        // è·å–æ‰€æœ‰å²—ä½
        async function getAllJobs() {
            try {
                const supabase = initSupabase();
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .order('is_hot', { ascending: false })
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('âŒ æŸ¥è¯¢å¤±è´¥:', error);
                    return [];
                }

                return data || [];
            } catch (err) {
                console.error('âŒ å¼‚å¸¸:', err);
                return [];
            }
        }

        // æ·»åŠ æ–°å²—ä½
        async function addJob(jobData) {
            try {
                const supabase = initSupabase();
                const { data, error } = await supabase
                    .from('jobs')
                    .insert(jobData)
                    .select();

                if (error) {
                    console.error('âŒ æ·»åŠ å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('âœ… å²—ä½æ·»åŠ æˆåŠŸ:', data);
                return { success: true, data };
            } catch (err) {
                console.error('âŒ å¼‚å¸¸:', err);
                return { success: false, error: err.message };
            }
        }

        // æ›´æ–°å²—ä½
        async function updateJob(id, jobData) {
            try {
                const supabase = initSupabase();
                const { data, error } = await supabase
                    .from('jobs')
                    .update(jobData)
                    .eq('id', id)
                    .select();

                if (error) {
                    console.error('âŒ æ›´æ–°å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('âœ… å²—ä½æ›´æ–°æˆåŠŸ:', data);
                return { success: true, data };
            } catch (err) {
                console.error('âŒ å¼‚å¸¸:', err);
                return { success: false, error: err.message };
            }
        }

        // åˆ é™¤å²—ä½
        async function deleteJob(id) {
            try {
                const supabase = initSupabase();
                const { error } = await supabase
                    .from('jobs')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('âŒ åˆ é™¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                return { success: true };
            } catch (err) {
                console.error('âŒ å¼‚å¸¸:', err);
                return { success: false, error: err.message };
            }
        }

        // æ¸²æŸ“å²—ä½åˆ—è¡¨
        function renderJobsList(jobs) {
            const container = document.getElementById('jobsListContainer');
            
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<p>æš‚æ— å²—ä½ä¿¡æ¯</p>';
                return;
            }

            const jobsHTML = `
                <div class="jobs-list">
                    ${jobs.map(job => `
                        <div class="job-item">
                            <h3 class="job-title">${job.title}</h3>
                            <div class="job-meta">
                                <p><strong>éƒ¨é—¨:</strong> ${job.department || 'æœªæŒ‡å®š'}</p>
                                <p><strong>åœ°ç‚¹:</strong> ${job.location || 'æœªæŒ‡å®š'}</p>
                                <p><strong>çŠ¶æ€:</strong> ${job.published ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'} ${job.is_hot ? '| ğŸ”¥ çƒ­æ‹›' : ''}</p>
                            </div>
                            <button class="btn btn-secondary" onclick="editJob(${job.id})">ç¼–è¾‘</button>
                            <button class="btn btn-delete" onclick="confirmDeleteJob(${job.id}, '${job.title}')">åˆ é™¤</button>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = jobsHTML;
        }

        // æ·»åŠ è¦æ±‚è¾“å…¥æ¡†
        function addRequirementInput(value = '') {
            const container = document.getElementById('requirementsContainer');
            const div = document.createElement('div');
            div.className = 'requirements-input';
            div.innerHTML = `
                <input type="text" class="requirement" value="${value}" placeholder="è¾“å…¥å²—ä½è¦æ±‚">
                <button type="button" class="btn btn-delete remove-requirement">åˆ é™¤</button>
            `;
            container.appendChild(div);

            // æ·»åŠ åˆ é™¤æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            div.querySelector('.remove-requirement').addEventListener('click', function() {
                div.remove();
            });
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const requirements = Array.from(document.querySelectorAll('.requirement'))
                .map(input => input.value.trim())
                .filter(value => value !== '');

            return {
                title: document.getElementById('title').value.trim(),
                department: document.getElementById('department').value.trim(),
                location: document.getElementById('location').value.trim(),
                requirements: requirements,
                is_hot: document.getElementById('isHot').checked,
                apply_url: document.getElementById('applyUrl').value.trim(),
                published: document.getElementById('published').checked
            };
        }

        // å¡«å……è¡¨å•æ•°æ®ï¼ˆç”¨äºç¼–è¾‘ï¼‰
        function fillFormData(job) {
            document.getElementById('jobId').value = job.id;
            document.getElementById('title').value = job.title || '';
            document.getElementById('department').value = job.department || '';
            document.getElementById('location').value = job.location || '';
            document.getElementById('isHot').checked = job.is_hot || false;
            document.getElementById('applyUrl').value = job.apply_url || '';
            document.getElementById('published').checked = job.published !== false; // é»˜è®¤ä¸ºtrue
            
            // æ¸…ç©ºå¹¶å¡«å……å²—ä½è¦æ±‚
            const container = document.getElementById('requirementsContainer');
            container.innerHTML = '';
            
            if (job.requirements && job.requirements.length > 0) {
                job.requirements.forEach(req => addRequirementInput(req));
            } else {
                addRequirementInput();
            }
            
            // æ›´æ”¹è¡¨å•æ ‡é¢˜
            document.getElementById('formTitle').textContent = 'ç¼–è¾‘å²—ä½';
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            document.getElementById('formTitle').textContent = 'æ·»åŠ æ–°å²—ä½';
            
            // é‡ç½®å²—ä½è¦æ±‚
            const container = document.getElementById('requirementsContainer');
            container.innerHTML = '';
            addRequirementInput();
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            const msgEl = document.getElementById('successMessage');
            msgEl.textContent = message;
            msgEl.classList.remove('hidden');
            setTimeout(() => msgEl.classList.add('hidden'), 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            const msgEl = document.getElementById('errorMessage');
            msgEl.textContent = message;
            msgEl.classList.remove('hidden');
            setTimeout(() => msgEl.classList.add('hidden'), 3000);
        }

        // ç¼–è¾‘å²—ä½
        async function editJob(id) {
            try {
                const jobs = await getAllJobs();
                const job = jobs.find(j => j.id === id);
                
                if (job) {
                    fillFormData(job);
                    // æ»šåŠ¨åˆ°è¡¨å•
                    document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showErrorMessage('åŠ è½½å²—ä½ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ç¡®è®¤åˆ é™¤å²—ä½
        function confirmDeleteJob(id, title) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å²—ä½ "${title}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                deleteJobById(id);
            }
        }

        // åˆ é™¤å²—ä½
        async function deleteJobById(id) {
            try {
                const result = await deleteJob(id);
                
                if (result.success) {
                    showSuccessMessage('å²—ä½åˆ é™¤æˆåŠŸï¼');
                    loadJobs();
                } else {
                    showErrorMessage('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showErrorMessage('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å²—ä½åˆ—è¡¨
        async function loadJobs() {
            try {
                const jobs = await getAllJobs();
                renderJobsList(jobs);
            } catch (error) {
                document.getElementById('jobsListContainer').innerHTML = 
                    `<p class="error-message">åŠ è½½å²—ä½åˆ—è¡¨å¤±è´¥: ${error.message}</p>`;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof window.supabase === 'undefined') {
                document.getElementById('jobsListContainer').innerHTML = 
                    '<p class="error-message">Supabaseåº“åŠ è½½å¤±è´¥</p>';
                return;
            }

            // åˆå§‹åŒ–å²—ä½è¦æ±‚è¾“å…¥æ¡†
            addRequirementInput();

            // æ·»åŠ è¦æ±‚æŒ‰é’®äº‹ä»¶
            document.getElementById('addRequirement').addEventListener('click', function() {
                addRequirementInput();
            });

            // é‡ç½®è¡¨å•æŒ‰é’®äº‹ä»¶
            document.getElementById('resetForm').addEventListener('click', function() {
                resetForm();
            });

            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('jobForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                console.log('ğŸ“ è¡¨å•æäº¤å¼€å§‹');
                
                const jobId = document.getElementById('jobId').value;
                const jobData = collectFormData();
                
                console.log('æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', jobData);
                
                if (!jobData.title) {
                    showErrorMessage('è¯·å¡«å†™å²—ä½åç§°');
                    console.error('âŒ å²—ä½åç§°ä¸ºç©º');
                    return;
                }

                let result;
                if (jobId) {
                    // æ›´æ–°ç°æœ‰å²—ä½
                    console.log('æ›´æ–°å²—ä½ID:', jobId);
                    result = await updateJob(jobId, jobData);
                } else {
                    // æ·»åŠ æ–°å²—ä½
                    console.log('æ·»åŠ æ–°å²—ä½');
                    result = await addJob(jobData);
                }

                console.log('æ“ä½œç»“æœ:', result);

                if (result.success) {
                    showSuccessMessage(jobId ? 'å²—ä½æ›´æ–°æˆåŠŸï¼' : 'å²—ä½æ·»åŠ æˆåŠŸï¼');
                    resetForm();
                    loadJobs();
                } else {
                    showErrorMessage((jobId ? 'æ›´æ–°' : 'æ·»åŠ ') + 'å¤±è´¥: ' + result.error);
                }
            });

            // åŠ è½½å²—ä½åˆ—è¡¨
            loadJobs();
        });
    </script>
</body>
</html>